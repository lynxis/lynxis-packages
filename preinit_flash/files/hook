#!/bin/sh
# Copyright (C) 2014 Alexander Couzens

. /usr/lib/preinit-flasher/lib

lazus_try() {
  local address="$1"
  local interface="$2"
  if [ ! -d /sys/class/net/${interface} ] ; then
    return
  fi

  modprobe ipv6
  sleep 3

  if [ "${address%%:*}" == "fe80" ] ; then
    address="${address}%${interface}"
  fi

  ping -6 -c 2 -W 2 -I $interface ${address}
  if [ $? -ne 0 ] ; then
    return
  fi

  busybox wget -T 3 -O /tmp/image.gpg http://[${address}]/preinit/$(cat /sys/class/net/${interface}/address)
  if [ $? -eq 0 ] ; then
    lazus_do_sysupgrade /tmp/image.gpg no
  fi
}

lazus_flasher() {
  for iface in $(ls /sys/class/net/) ; do
    [ "$iface" == "lo" ] && continue
    lazus_try fe80::08ef:2342 $iface
  done
}

boot_hook_add preinit_main lazus_flasher

